# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a provenance validation example demonstrating Sigstore-based container image signing, verification, and in-toto supply chain security. It contains a simple Flask application packaged in Docker, with a GitHub Actions workflow that builds, signs, and verifies container images using keyless signing, while enforcing supply chain policies with in-toto.

## Architecture

- **app.py**: Minimal Flask web server (port 8080)
- **Dockerfile**: Python 3.11-slim based container build
- **in-toto-layout.json**: Supply chain policy defining required steps (checkout, build, sign)
- **verify-supply-chain.sh**: Script to verify in-toto supply chain compliance
- **.github/workflows/build-and-sign.yml**: CI/CD pipeline that:
  - Builds multi-platform images (amd64/arm64)
  - Pushes to GitHub Container Registry (ghcr.io)
  - Signs images using Cosign with Sigstore keyless signing
  - Generates SLSA provenance attestations with cosign attest
  - Creates in-toto link metadata for each supply chain step
  - Verifies signatures, provenance, and supply chain policy compliance

## Key Commands

```bash
# Local development
pip install -r requirements.txt
python app.py

# Docker build
docker build -t pv_example .
docker run -p 8080:8080 pv_example

# Verify a signed image (requires cosign)
cosign verify ghcr.io/<repo>@<digest> \
  --certificate-identity-regexp="https://github.com/<repo>/*" \
  --certificate-oidc-issuer=https://token.actions.githubusercontent.com

# Verify attestations
cosign verify-attestation ghcr.io/<repo>@<digest> \
  --certificate-identity-regexp="https://github.com/<repo>/*" \
  --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
  --type slsaprovenance

# Verify in-toto supply chain (requires in-toto link metadata)
pip install in-toto
./verify-supply-chain.sh
```

## Sigstore/Cosign Notes

- Uses OIDC-based keyless signing via GitHub Actions
- Requires `id-token: write` permission for OIDC token generation
- Provenance attestations created with `cosign attest` and verified with `cosign verify-attestation`
- Image signatures created with `cosign sign` and verified with `cosign verify`

## in-toto Supply Chain Security

- **Layout file** (`in-toto-layout.json`): Defines three required steps:
  1. `checkout`: Verifies source code files are present
  2. `build`: Ensures build uses checked-out materials and produces image digest
  3. `sign`: Confirms image was signed and signature verified
- **Link metadata**: Generated by `in-toto-run` for each step, recording materials (inputs) and products (outputs)
- **Verification**: `verify-supply-chain.sh` uses `in-toto-verify` to ensure all steps were executed in order with correct inputs/outputs
- **Artifacts**: Link metadata files (*.link) are uploaded as GitHub Actions artifacts for offline verification
